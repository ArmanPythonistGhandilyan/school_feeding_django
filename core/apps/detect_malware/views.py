from asgiref.sync import sync_to_async
from django.http import HttpResponse
from django.shortcuts import render

from .forms import MyForm
from .services import is_malicious_async


async def detect_malware(request):
    if request.method == "POST":
        form = MyForm(request.POST, request.FILES)
        file = request.FILES["file"]
        if form.is_valid():
            if not await is_malicious_async(file):
                await sync_to_async(form.save)()
            else:
                pass
        else:
            return HttpResponse("form is not valid")
        return render(request, "detect_malware/index.html")
    return render(request, "detect_malware/index.html")
