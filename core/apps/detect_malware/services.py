import hashlib
from pathlib import Path

import environ
import vt

BASE_DIR = Path(__file__).resolve().parent.parent.parent.parent

env = environ.Env()
environ.Env.read_env(BASE_DIR / ".env")


async def is_malicious_async(file):
    client = vt.Client(
        env("VT_API_KEY")
    )
    file_data = file.read()
    sha256hash = hashlib.sha256(file_data).hexdigest()
    try:
        analysis = await client.get_object_async("/files/{}", sha256hash)
        category = analysis.sandbox_verdicts["Lastline"]["category"]
    except vt.error.APIError:
        category = None
    return True if category == "malicious" else False
